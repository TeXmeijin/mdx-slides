<!DOCTYPE html><html lang="en"><head><meta http-equiv="Content-type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>slide</title><meta property="og:title" content="slide"><meta property="og:type" content="article"><script defer="defer" src="runtime.9cbd935d60ed91ef44a4.bundle.js"></script><script defer="defer" src="vendor.924d674b8e2e95045c6a.bundle.js"></script><script defer="defer" src="main.ecc396f9e6aa800a4d9c.bundle.js"></script><link href="vendor.924d674b8e2e95045c6a.css" rel="stylesheet"><link href="main.ecc396f9e6aa800a4d9c.css" rel="stylesheet"><link rel="prefetch" as="script" href="921.fed30f6e7e4b7084d664.bundle.js"></head><body><div id="root"><div class="swiper-container swiper-container-initialized swiper-container-horizontal swiper-container-pointer-events"><div class="swiper-pagination"></div><div class="swiper-wrapper" id="swiper-wrapper-c40e3be882d80e75" aria-live="polite" style="transform: translate3d(0px, 0px, 0px);"><div class="swiper-slide title swiper-slide-active" data-hash="slide-1" role="group" aria-label="1 / 23" style="width: 1200px;"><div class="slide-internal-box"><h1><span>React Native×Firebaseで</span><span>オンライン指導用の</span><span>チャットアプリを開発している話</span></h1><div class="grid"><a href="https://twitter.com/meijin_garden" class="account account-twitter" aria-label="account-twitter"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path></svg></a></div></div></div><div class="swiper-slide section-title swiper-slide-next" data-hash="slide-2" role="group" aria-label="2 / 23" style="width: 1200px;"><div class="slide-internal-box"><h1>目次</h1><ul><li>自己紹介</li><li>開発しているサービス</li><li>アプリで開発している機能</li><li>開発体制</li><li>React Nativeの利用ライブラリ</li><li>React Nativeの品質管理</li><li>React Nativeの落とし穴</li><li>Firebaseの利用ライブラリ</li><li>Firebaseの設計</li><li>Firebaseの落とし穴</li><li>この技術選定で良かったと思うこと</li><li>まとめ</li></ul></div></div><div class="swiper-slide" data-hash="slide-3" role="group" aria-label="3 / 23" style="width: 1200px;"><div class="slide-internal-box"><h1>自己紹介</h1><div class="grid"><div class="column"><figure><img src="aa307a7cc38382b5fd86.webp" alt="自己紹介" class="self-introduce" width="200" height="320"></figure></div><div class="column left flex-start"><ul><li>ハンドルネーム”名人”</li><li>株式会社NoSchool CTO</li><li>オンライン家庭教師を広める教育サービスを開発しています(<a href="https://manalink.jp">https://manalink.jp</a>)</li><li>好きな言語はTypeScript</li><li>趣味<ul><li>将棋(指すのも観戦するのも好き)</li><li>ゲーム(最近はゼルダ無双)</li></ul></li></ul></div></div></div></div><div class="swiper-slide" data-hash="slide-4" role="group" aria-label="4 / 23" style="width: 1200px;"><div class="slide-internal-box"><h1>開発しているサービス</h1><div class="grid"><div class="column"><img src="a5178017b682998d3f57.webp" alt="Image from Gyazo" style="width: 350px;"></div><div class="column left flex-start"><ul><li>マナリンク</li><li>中高生向けのオンライン家庭教師サービス</li><li>「優秀な先生が世界中どこに居ても教育の仕事ができるようにする」が目標</li><li>先生を一人ひとり審査していて、カナダ在住の先生とか、中高生に株を教える個性的な先生など在籍している</li><li>Web上で先生を探して指導依頼ができる</li><li>指導開始後はアプリを使ってご家庭↔先生でやり取りができる</li></ul></div></div></div></div><div class="swiper-slide" data-hash="slide-5" role="group" aria-label="5 / 23" style="width: 1200px;"><div class="slide-internal-box"><h1>図にするとこんな感じ</h1></div></div><div class="swiper-slide left" data-hash="slide-6" role="group" aria-label="6 / 23" style="width: 1200px;"><div class="slide-internal-box"><h1>アプリで開発している機能</h1><h2>いま</h2><ul><li>先生、生徒、保護者が利用できる</li><li>チャット(文章、各種ファイル)で連絡できる<ul><li>iOS / Android対応</li><li>Web↔アプリ間でもチャットができる</li></ul></li></ul><h2>これから</h2><ul><li>先生が勉強計画を立て、日々生徒が報告する機能</li><li>試験日や指導日を共有できる管理機能</li></ul><p><strong>→先生個人がデジタル化した指導を実践できるようにしていく</strong></p></div></div><div class="swiper-slide" data-hash="slide-7" role="group" aria-label="7 / 23" style="width: 1200px;"><div class="slide-internal-box"><h1>アプリの開発体制と利用技術</h1><div class="grid"><div class="flex"><img src="1e26f5e050e96a101f3b.webp" alt="Image from Gyazo" style="height: 500px; width: 220px;"><img src="4c379f54d4cc60ecd3e5.webp" alt="Image from Gyazo" style="height: 500px; width: 220px; margin-left: 20px;"></div><div class="column left flex-start"><ul><li>開発体制<ul><li>業務委託エンジニア1名(+ときどきCTO)</li><li>めっちゃベンチャーです</li></ul></li><li>利用技術<ul><li>React Native</li><li>Expo(Managed Workflow)</li><li>Firebase</li><li>TypeScript</li></ul></li></ul></div></div></div></div><div class="swiper-slide" data-hash="slide-8" role="group" aria-label="8 / 23" style="width: 1200px;"><div class="slide-internal-box"><h1>React Nativeの利用ライブラリ</h1></div></div><div class="swiper-slide left" data-hash="slide-9" role="group" aria-label="9 / 23" style="width: 1200px;"><div class="slide-internal-box"><h1>react-native-gifted-chat</h1><div class="grid"><div class="column"><pre class="  language-jsx"><code class="  language-jsx"><span class="token operator">&lt;</span>GiftedChat
  messages<span class="token operator">=</span><span class="token punctuation">{</span>chatMessages<span class="token punctuation">}</span>
  onSend<span class="token operator">=</span><span class="token punctuation">{</span>onSend<span class="token punctuation">}</span>
  placeholder<span class="token operator">=</span><span class="token string">"メッセージを入力"</span>
  renderBubble<span class="token operator">=</span><span class="token punctuation">{</span>renderBubble<span class="token punctuation">}</span>
  renderInputToolbar<span class="token operator">=</span><span class="token punctuation">{</span>renderInputToolbar<span class="token punctuation">}</span>
  renderActions<span class="token operator">=</span><span class="token punctuation">{</span>renderActions<span class="token punctuation">}</span>
  renderComposer<span class="token operator">=</span><span class="token punctuation">{</span>renderComposer<span class="token punctuation">}</span>
  renderSend<span class="token operator">=</span><span class="token punctuation">{</span>renderSend<span class="token punctuation">}</span>
  renderMessageImage<span class="token operator">=</span><span class="token punctuation">{</span>renderMessageImage<span class="token punctuation">}</span>
  infiniteScroll
  <span class="token comment">// 以下略</span>
<span class="token operator">/</span><span class="token operator">&gt;</span>
</code></pre></div><div class="column left"><ul><li>チャット画面を丸っと囲うGiftedChatコンポーネントを置くだけ</li><li>各メッセージや送信ボタンなどは外からFunctionalなComponentを渡すことでカスタマイズできる</li><li>カスタマイズしすぎるとライブラリの範囲を逸脱してくるので、いつかはリプレイスする</li></ul></div></div></div></div><div class="swiper-slide" data-hash="slide-10" role="group" aria-label="10 / 23" style="width: 1200px;"><div class="slide-internal-box"><h1>チャットをゼロから作るのは割と大変</h1><div class="grid"><div class="flex"><img src="4cd6dddd3aedab0b8326.webp" alt="Image from Gyazo" style="width: 330px;"></div><div class="column left flex-start"><h4>以下の内容はreact-native-gifted-chatがやっている</h4><ul><li>チャットの吹き出しの形<ul><li>よく見ると、連投したときの角丸の形が微妙に違う</li><li>連投すると最後の投稿だけユーザーアイコンがつく</li></ul></li><li>日時表示<ul><li>日付が変わるたびに日付表示をインサートしている</li></ul></li><li>表示位置<ul><li>新着メッセージが来るたびに自動でスクロール</li></ul></li></ul><p>WebではVueで全部自作したけど結構大変だった(勉強にはなった)</p><p>これを機にLINEのUIをじっくり眺めるととても感心した思い出</p></div></div></div></div><div class="swiper-slide" data-hash="slide-11" role="group" aria-label="11 / 23" style="width: 1200px;"><div class="slide-internal-box"><h1>Firebase×React Hooks関連のライブラリ</h1><h2>react-firebase-hooks</h2><ul><li><a href="https://github.com/CSFrequency/react-firebase-hooks">https://github.com/CSFrequency/react-firebase-hooks</a></li><li>FirestoreのCollectionデータ、読み込み中フラグ、エラー内容をセットで返すHook</li></ul><pre class="  language-typescript"><code class="  language-typescript"><span class="token keyword">const</span> <span class="token punctuation">[</span>values<span class="token punctuation">,</span> loading<span class="token punctuation">,</span> error<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token generic-function"><span class="token function">useCollectionData</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><br><h2>react-firebase-pagination-hooks</h2><ul><li>チャットのメッセージをページングして、無限スクロールを実装</li><li>loadMoreメソッドを実行すれば次のデータが読み込める</li></ul><pre class="  language-typescript"><code class="  language-typescript"><span class="token keyword">const</span> <span class="token punctuation">[</span>messages<span class="token punctuation">,</span> <span class="token punctuation">{</span> loaded<span class="token punctuation">,</span> loadingMore<span class="token punctuation">,</span> loadMore <span class="token punctuation">}</span><span class="token punctuation">,</span> error<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token generic-function"><span class="token function">usePaginationData</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></div><div class="swiper-slide" data-hash="slide-12" role="group" aria-label="12 / 23" style="width: 1200px;"><div class="slide-internal-box"><h1>React Nativeの品質管理</h1><ul><li>React Nativeに関してはテストコードは皆無(汗)<ul><li>機能が少なく、ライブラリ依存が大きいため</li><li>毎回ウォークスルーテストを手動でしている</li><li>複雑なフックが増えてきたので書きたい気持ちはある</li></ul></li><li>エラー検知はSentry<ul><li>画面遷移やメッセージ送信時などでイベントを発火して記録</li><li>エラーログが出ると、イベントを辿ることでユーザーの動きを擬似再現できる</li><li>ユーザーIDも紐付けができる</li><li>ソースマップをSentryにデプロイすることで、エラーが起きたソースコードの該当箇所を特定しやすい</li></ul></li></ul><pre class="  language-typescript"><code class="  language-typescript">Sentry<span class="token punctuation">.</span><span class="token function">addBreadcrumb</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  category<span class="token operator">:</span> <span class="token string">'ACTION'</span><span class="token punctuation">,</span>
  message<span class="token operator">:</span> <span class="token string">'SEND_CHAT_MESSAGE'</span><span class="token punctuation">,</span>
  data<span class="token operator">:</span> <span class="token punctuation">{</span>
    roomId<span class="token operator">:</span> room<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
    userId<span class="token operator">:</span> user<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></div><div class="swiper-slide" data-hash="slide-13" role="group" aria-label="13 / 23" style="width: 1200px;"><div class="slide-internal-box"><h1>React Nativeの落とし穴</h1><h2>ハマると解決が厳しい</h2><ul><li>某ライブラリと某ライブラリを併用し、かつ特定の動作をユーザーが行うとアプリがクラッシュする事案があった<ul><li>画面が突然ブラックアウトして強制的に再起動になる</li><li>発動条件がニッチだが、本番環境で再現するユーザーがいて修正必須となった</li></ul></li><li>直接的な原因が全く不明<ul><li>クラッシュが突然ブラックアウトするためエラーログが取れない</li><li>ライブラリのソースを追っても、ある程度追うとネイティブのコードになり謎が深まる</li></ul></li></ul><p>結局何が原因か分からないままに、当該ライブラリの組み合わせを変えることで解消...</p></div></div><div class="swiper-slide" data-hash="slide-14" role="group" aria-label="14 / 23" style="width: 1200px;"><div class="slide-internal-box"><h2>いつでもiOS/Androidで同じと思うなよ</h2><ul><li>チャットで画像を送信するとき、画素数を落とさずにファイルサイズを小さくするために圧縮した<ul><li>expo-image-manipulatorを使った</li><li>ImageManipulator.manipulateAsyncで圧縮しようとすると、同じ圧縮率を指定してもAndroidから実行すると<strong>画像が圧縮されすぎてしまった</strong></li><li>OSごとに分岐して圧縮率を調整することで解消</li><li>ソースレビューの段階では何ら問題なく見えるので恐ろしい</li></ul></li><li>他にも通知周りなど、細かいところで結局OSごとに分岐する箇所があるので、両OSでの実機確認は必須</li></ul></div></div><div class="swiper-slide" data-hash="slide-15" role="group" aria-label="15 / 23" style="width: 1200px;"><div class="slide-internal-box"><h1>Firebaseの利用ライブラリ</h1></div></div><div class="swiper-slide" data-hash="slide-16" role="group" aria-label="16 / 23" style="width: 1200px;"><div class="slide-internal-box"><h2>firestore-simple</h2><pre class="  language-typescript"><code class="  language-typescript"><span class="token keyword">const</span> roomDao <span class="token operator">=</span> firestoreSimple<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">collection</span><span class="token generic class-name"><span class="token operator">&lt;</span>Room<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> path<span class="token operator">:</span> <span class="token string">'rooms'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> allRooms <span class="token operator">=</span> <span class="token keyword">await</span> roomDao<span class="token punctuation">.</span><span class="token function">fetchAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div></div><div class="swiper-slide" data-hash="slide-17" role="group" aria-label="17 / 23" style="width: 1200px;"><div class="slide-internal-box"><h1>Firebaseの設計</h1></div></div><div class="swiper-slide" data-hash="slide-18" role="group" aria-label="18 / 23" style="width: 1200px;"><div class="slide-internal-box"><h1>Firebaseの落とし穴</h1></div></div><div class="swiper-slide" data-hash="slide-19" role="group" aria-label="19 / 23" style="width: 1200px;"><div class="slide-internal-box"><h1>この技術選定で良かったと思うこと</h1></div></div><div class="swiper-slide" data-hash="slide-20" role="group" aria-label="20 / 23" style="width: 1200px;"><div class="slide-internal-box"><h2>1. 簡単な修正ならWebエンジニア(僕)でも理解・実装できる</h2><ul><li>そもそもReactが個人的に好き(突然の主観)<ul><li>最近練習を兼ねてRNで個人開発しているが、TSXを書くのが楽しいしスタイルもCSS感覚なので敷居が本当に低い</li></ul></li><li>特にExpoのManaged Workflowの場合は環境構築時に各OSの存在をほとんど意識しなくて良いので楽</li><li>実例として、FrontのFirebaseは全く同じライブラリをVueでも使っているので、Webのコードをほぼそのままコピペで持ってこれる<ul><li>先日FirebaseのStorageにファイルを上げる時に、content-dispositionヘッダを指定することでダウンロード時にファイル名を維持する施策を実装したが、ほぼ同じコードでWeb/アプリを実装できたので便利さを実感した</li><li>コードそのものを共有するのは限界があるので、相互に人材および知見を共有できる程度に思っている</li></ul></li></ul></div></div><div class="swiper-slide" data-hash="slide-21" role="group" aria-label="21 / 23" style="width: 1200px;"><div class="slide-internal-box"><h2>2. 受験シーズンに間に合うように開発でき、機能検証ができた</h2><ul><li>昨年6月から開発スタートし、紆余曲折あったが10月にはリリースできた</li><li>オンライン指導用のアプリなので、クロスプラットフォームで平等に使ってもらう必要があった</li><li>React Nativeで開発することで受験シーズンに間に合い、積極的に使ってもらうことができた</li><li><strong>チャットで親・先生・生徒がやり取りでき、ファイルや画像も送れるのはIT界隈の人間からすると当然だが、案外事業者側でそこまで内製する企業が少ないらしく、特に先生から好評をいただくことができた</strong><ul><li>実際、チャット機能は作り込みだすとそれなりに大変ですが(小声)</li></ul></li><li>総じて、<strong>教育事業が最も盛り上がる受験シーズンまでに、最低限どんな機能があればニーズが満たせるか理解できた</strong>ので、React Nativeをやってよかった<ul><li>スタートアップの検証サイクル的にはとても有り難い技術</li><li>(初期リリースの内容を予定から絞って、チャットをまずは作り込む判断も良かった)</li></ul></li></ul></div></div><div class="swiper-slide" data-hash="slide-22" role="group" aria-label="22 / 23" style="width: 1200px;"><div class="slide-internal-box"><h1>まとめ</h1></div></div><div class="swiper-slide" data-hash="slide-23" role="group" aria-label="23 / 23" style="width: 1200px;"><div class="slide-internal-box"><h2>言いたいことメモ</h2><ul><li>React Native×TSX×Hooksをベースに開発している</li><li>Firebaseも含めて全部TypeScriptで完結している</li><li>Webエンジニアでも簡単なHooksの改善程度なら積極的に参加できる</li><li>react-firebase-hooks, firestore-simpleおすすめ</li><li>謎のクラッシュなど、ハマると結構打つ手なくなるのがしんどい</li><li>画像の圧縮時にAndroidとiOSで地味に違う挙動が起こる罠ｗ</li><li>Expoのプッシュ通知が割と落ちるのでリトライ機構を組んだ</li><li>FirestoreはWriteを頑張り、Readがシンプルで済むように組むのがベター</li><li>限られた開発体制でも短期間で開発でき受験シーズンに間に合った。チャット機能でミニマムどれくらい機能が必要かも分かった。スタートアップの検証サイクル的にはとても有り難い技術。</li></ul></div></div></div><span class="swiper-notification" aria-live="assertive" aria-atomic="true"></span></div></div></body></html>