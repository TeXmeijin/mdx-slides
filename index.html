<!DOCTYPE html><html lang="en"><head><meta http-equiv="Content-type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>slide</title><meta property="og:title" content="slide"><meta property="og:type" content="article"><script defer="defer" src="runtime.c1e157faa2426e34926f.bundle.js"></script><script defer="defer" src="vendor.91b9fae0abcb172cf3f2.bundle.js"></script><script defer="defer" src="main.42bc817bc6be7671914e.bundle.js"></script><link href="vendor.91b9fae0abcb172cf3f2.css" rel="stylesheet"><link href="main.42bc817bc6be7671914e.css" rel="stylesheet"><link rel="prefetch" as="script" href="921.18ebea63d6dadb884d98.bundle.js"></head><body><div id="root"><div class="swiper-container swiper-container-initialized swiper-container-horizontal swiper-container-pointer-events"><div class="swiper-pagination"></div><div class="swiper-wrapper" id="swiper-wrapper-8d4e220a3ae49abb" aria-live="polite" style="transform: translate3d(0px, 0px, 0px);"><div class="swiper-slide title swiper-slide-active" data-hash="slide-1" role="group" aria-label="1 / 25" style="width: 1184px;"><div class="slide-internal-box"><h1><span>React Native×Firebaseで</span><span>オンライン指導用の</span><span>チャットアプリを開発している話</span></h1><div class="grid"><a href="https://twitter.com/meijin_garden" class="account account-twitter" aria-label="account-twitter"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path></svg></a></div></div></div><div class="swiper-slide section-title swiper-slide-next" data-hash="slide-2" role="group" aria-label="2 / 25" style="width: 1184px;"><div class="slide-internal-box"><h1>目次</h1><ul><li>自己紹介</li><li>開発しているサービス</li><li>React Nativeの利用ライブラリ</li><li>React Nativeの品質管理</li><li>React Nativeの落とし穴</li><li>Firebaseの利用ライブラリ</li><li>Firebaseの品質管理</li><li>Firebaseの落とし穴</li><li>この技術選定で良かったと思うこと</li><li>まとめ</li></ul></div></div><div class="swiper-slide" data-hash="slide-3" role="group" aria-label="3 / 25" style="width: 1184px;"><div class="slide-internal-box"><h1>自己紹介</h1><div class="grid"><div class="column"><figure><img src="aa307a7cc38382b5fd86.webp" alt="自己紹介" class="self-introduce" width="200" height="320"></figure></div><div class="column left flex-start"><ul><li>ハンドルネーム”名人”</li><li>株式会社NoSchool CTO</li><li>オンライン家庭教師を広める教育サービス”マナリンク”を開発しています(<a href="https://manalink.jp">https://manalink.jp</a>)</li><li>好きな言語はTypeScript</li><li>好きなIDEはPHPStorm</li><li>趣味<ul><li>将棋(指すのも観戦するのも好き)</li><li>ゲーム(最近はゼルダ無双)</li></ul></li></ul></div></div></div></div><div class="swiper-slide" data-hash="slide-4" role="group" aria-label="4 / 25" style="width: 1184px;"><div class="slide-internal-box"><h1>開発しているサービス</h1><div class="grid"><div class="column"><img src="a5178017b682998d3f57.webp" alt="Image from Gyazo" style="width: 350px;"></div><div class="column left flex-start"><ul><li>マナリンク</li><li>中高生向けのオンライン家庭教師サービス</li><li>Web上で先生を探して指導依頼</li><li>指導開始後はアプリを使ってご家庭↔先生でやり取り</li></ul></div></div></div></div><div class="swiper-slide" data-hash="slide-5" role="group" aria-label="5 / 25" style="width: 1184px;"><div class="slide-internal-box"><h1>図にするとこんな感じ</h1><img src="96dcaed69c1891edccc8.webp" alt="Image from Gyazo" style="width: 85%;"></div></div><div class="swiper-slide left" data-hash="slide-6" role="group" aria-label="6 / 25" style="width: 1184px;"><div class="slide-internal-box"><h1>アプリで開発している機能</h1><h2>いま</h2><ul><li>先生、生徒、保護者が利用できる</li><li>チャット(文章、画像、PDF、.docxなど)で連絡できる<ul><li>iOS / Android対応</li><li>Web(Nuxt.js)↔アプリ間でもチャットができる</li></ul></li></ul><h2>これから</h2><ul><li>先生が勉強計画を立て、日々生徒が報告する機能</li><li>試験日や指導日を共有できる管理機能</li></ul><p><strong>→先生個人が(塾などに属さなくても)デジタル化した指導を実践できるようにしていく</strong></p></div></div><div class="swiper-slide" data-hash="slide-7" role="group" aria-label="7 / 25" style="width: 1184px;"><div class="slide-internal-box"><h1>アプリの開発体制と利用技術</h1><div class="grid"><div class="flex"><img src="1e26f5e050e96a101f3b.webp" alt="Image from Gyazo" style="height: 500px; width: 220px;"><img src="4c379f54d4cc60ecd3e5.webp" alt="Image from Gyazo" style="height: 500px; width: 220px; margin-left: 20px;"></div><div class="column left flex-start"><ul><li>開発体制<ul><li>業務委託エンジニア1名(+ときどきCTO)</li><li>めっちゃベンチャーです</li></ul></li><li>利用技術<ul><li>React Native</li><li>Expo(Managed Workflow)</li><li>Firebase</li><li>TypeScript</li></ul></li></ul></div></div></div></div><div class="swiper-slide" data-hash="slide-8" role="group" aria-label="8 / 25" style="width: 1184px;"><div class="slide-internal-box"><h1>React Nativeの利用ライブラリ</h1></div></div><div class="swiper-slide left" data-hash="slide-9" role="group" aria-label="9 / 25" style="width: 1184px;"><div class="slide-internal-box"><h1>react-native-gifted-chat</h1><div class="grid"><div class="column"><pre class="  language-jsx"><code class="  language-jsx"><span class="token operator">&lt;</span>GiftedChat
  messages<span class="token operator">=</span><span class="token punctuation">{</span>chatMessages<span class="token punctuation">}</span>
  onSend<span class="token operator">=</span><span class="token punctuation">{</span>onSend<span class="token punctuation">}</span>
  placeholder<span class="token operator">=</span><span class="token string">"メッセージを入力"</span>
  renderBubble<span class="token operator">=</span><span class="token punctuation">{</span>renderBubble<span class="token punctuation">}</span>
  renderInputToolbar<span class="token operator">=</span><span class="token punctuation">{</span>renderInputToolbar<span class="token punctuation">}</span>
  renderActions<span class="token operator">=</span><span class="token punctuation">{</span>renderActions<span class="token punctuation">}</span>
  renderComposer<span class="token operator">=</span><span class="token punctuation">{</span>renderComposer<span class="token punctuation">}</span>
  renderSend<span class="token operator">=</span><span class="token punctuation">{</span>renderSend<span class="token punctuation">}</span>
  renderMessageImage<span class="token operator">=</span><span class="token punctuation">{</span>renderMessageImage<span class="token punctuation">}</span>
  infiniteScroll
  <span class="token comment">// 以下略</span>
<span class="token operator">/</span><span class="token operator">&gt;</span>
</code></pre></div><div class="column left"><ul><li>チャット画面を丸っと囲うGiftedChatコンポーネントを置くだけ</li><li>各メッセージや送信ボタンなどは外からFunctionalなComponentを渡すことでカスタマイズできる</li><li>カスタマイズしすぎるとライブラリの範囲を逸脱してくるので、いつかはリプレイスする</li></ul></div></div></div></div><div class="swiper-slide" data-hash="slide-10" role="group" aria-label="10 / 25" style="width: 1184px;"><div class="slide-internal-box"><h1>チャットをゼロから作るのは割と大変</h1><div class="grid"><div class="flex"><img src="4cd6dddd3aedab0b8326.webp" alt="Image from Gyazo" style="width: 330px;"></div><div class="column left flex-start"><h4>以下の内容はreact-native-gifted-chatがやっている</h4><ul><li>チャットの吹き出しの形<ul><li>よく見ると、連投したときの角丸の形が微妙に違う</li><li>連投すると最後の投稿だけユーザーアイコンがつく</li></ul></li><li>日時表示<ul><li>日付が変わるたびに日付表示をインサートしている</li></ul></li><li>表示位置<ul><li>新着メッセージが来るたびに自動でスクロール</li></ul></li></ul><p>WebではVueで全部自作したけど結構大変だった(勉強にはなった)</p><p>これを機にLINEのUIをじっくり眺めるととても感心した思い出</p></div></div></div></div><div class="swiper-slide" data-hash="slide-11" role="group" aria-label="11 / 25" style="width: 1184px;"><div class="slide-internal-box"><h1>Firebase×React Hooks関連のライブラリ</h1><h2>react-firebase-hooks</h2><ul><li><a href="https://github.com/CSFrequency/react-firebase-hooks">https://github.com/CSFrequency/react-firebase-hooks</a></li><li>FirestoreのCollectionデータ、読み込み中フラグ、エラー内容をセットで返すHook</li></ul><pre class="  language-typescript"><code class="  language-typescript"><span class="token keyword">const</span> <span class="token punctuation">[</span>values<span class="token punctuation">,</span> loading<span class="token punctuation">,</span> error<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token generic-function"><span class="token function">useCollectionData</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><br><h2>react-firebase-pagination-hooks</h2><ul><li>チャットのメッセージをページングして、無限スクロールを実装</li><li>loadMoreメソッドを実行すれば次のデータが読み込める</li></ul><pre class="  language-typescript"><code class="  language-typescript"><span class="token keyword">const</span> <span class="token punctuation">[</span>messages<span class="token punctuation">,</span> <span class="token punctuation">{</span> loaded<span class="token punctuation">,</span> loadingMore<span class="token punctuation">,</span> loadMore <span class="token punctuation">}</span><span class="token punctuation">,</span> error<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token generic-function"><span class="token function">usePaginationData</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></div><div class="swiper-slide" data-hash="slide-12" role="group" aria-label="12 / 25" style="width: 1184px;"><div class="slide-internal-box"><h1>React Nativeの品質管理</h1><ul><li>React Nativeに関してはテストコードは皆無(汗)<ul><li>機能が少なく、ライブラリ依存が大きいため</li><li>毎回ウォークスルーテストを手動でしている</li><li>複雑なフックが増えてきたので書きたい気持ちはある</li></ul></li><li>エラー検知はSentry<ul><li>画面遷移やメッセージ送信時などでイベントを発火して記録</li><li>エラーログが出ると、イベントを辿ることでユーザーの動きを擬似再現できる</li><li>ユーザーIDも紐付けができる</li><li>ソースマップをSentryにデプロイすることで、エラーが起きたソースコードの該当箇所を特定しやすい</li></ul></li></ul><pre class="  language-typescript"><code class="  language-typescript">Sentry<span class="token punctuation">.</span><span class="token function">addBreadcrumb</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  category<span class="token operator">:</span> <span class="token string">'ACTION'</span><span class="token punctuation">,</span>
  message<span class="token operator">:</span> <span class="token string">'SEND_CHAT_MESSAGE'</span><span class="token punctuation">,</span>
  data<span class="token operator">:</span> <span class="token punctuation">{</span>
    roomId<span class="token operator">:</span> room<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
    userId<span class="token operator">:</span> user<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></div><div class="swiper-slide" data-hash="slide-13" role="group" aria-label="13 / 25" style="width: 1184px;"><div class="slide-internal-box"><h1>React Nativeの落とし穴</h1><h2>ハマると解決が厳しい</h2><ul><li>某ライブラリと某ライブラリを併用し、かつ特定の動作をユーザーが行うとアプリがクラッシュする事案があった<ul><li>画面が突然ブラックアウトして強制的に再起動になる</li><li>発動条件がニッチだが、本番環境で再現するユーザーがいて修正必須となった</li><li>直接的な原因が全く不明</li><li>クラッシュが突然ブラックアウトするためエラーログが取れない</li><li>ライブラリのソースを追っても、ある程度追うとネイティブのコードになり謎が深まる</li></ul></li></ul><p>結局何が原因か分からないままに、当該ライブラリの組み合わせを変えることで解消...</p></div></div><div class="swiper-slide" data-hash="slide-14" role="group" aria-label="14 / 25" style="width: 1184px;"><div class="slide-internal-box"><h2>いつでもiOS/Androidで同じと思うなよ現象</h2><ul><li>チャットで画像を送信するとき、画素数を落とさずにファイルサイズを小さくするために圧縮した<ul><li>expo-image-manipulatorのImageManipulator.manipulateAsyncで圧縮しようとすると、同じ圧縮率を指定してもAndroidから実行すると<strong>画像が圧縮されすぎてしまった</strong></li><li>OSごとに分岐して圧縮率を調整することで解消</li><li>ソースレビューの段階では何ら問題なく見えるので恐ろしい</li></ul></li><li>他にも通知周りなど、細かいところで結局OSごとに分岐する箇所があるので、両OSでの実機確認は必須</li></ul></div></div><div class="swiper-slide" data-hash="slide-15" role="group" aria-label="15 / 25" style="width: 1184px;"><div class="slide-internal-box"><h1>Firebaseの利用ライブラリ</h1></div></div><div class="swiper-slide" data-hash="slide-16" role="group" aria-label="16 / 25" style="width: 1184px;"><div class="slide-internal-box"><h2>firestore-simple</h2><ul><li>Firestoreに対する形安全なDAOが手に入れられるライブラリ</li></ul><pre class="  language-typescript"><code class="  language-typescript"><span class="token keyword">const</span> roomDao <span class="token operator">=</span> firestoreSimple<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">collection</span><span class="token generic class-name"><span class="token operator">&lt;</span>Room<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> path<span class="token operator">:</span> <span class="token string">'rooms'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> allRooms <span class="token operator">=</span> <span class="token keyword">await</span> roomDao<span class="token punctuation">.</span><span class="token function">fetchAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// allRooms: Room[]</span>
</code></pre></div></div><div class="swiper-slide" data-hash="slide-17" role="group" aria-label="17 / 25" style="width: 1184px;"><div class="slide-internal-box"><h1>Firebaseの設計</h1><h2>Firestoreは書き込み処理に重点を置く</h2><ul><li>SQLと違って読み取りクエリが貧弱</li><li>非正規化を許容して、読み取りの仕様に合わせて最適化したコレクションを作る</li><li>例：チャット部屋一覧で最新のメッセージを見せるために、messagesコレクションのonCreateでroomsコレクションに最新のメッセージを遅れて同期させる</li><li>例：全ての未読数の合計を出すために、messagesへのonWriteハンドラでユーザーごとに未読数を集計して別途保存する</li></ul></div></div><div class="swiper-slide" data-hash="slide-18" role="group" aria-label="18 / 25" style="width: 1184px;"><div class="slide-internal-box"><h1>Firebaseの品質管理</h1><h2>FunctionsでのエラーログをSlack通知</h2><ul><li><a href="https://zenn.dev/meijin/scraps/94d4a70eb77507">https://zenn.dev/meijin/scraps/94d4a70eb77507</a></li><li>Functionsでキャッチされなかった例外も含めSlack等でキャッチアップしたかった</li><li>Cloud Functionsログ→GCP→ログルーター→PubSubトピック→Cloud Function→Slack通知</li></ul></div></div><div class="swiper-slide" data-hash="slide-19" role="group" aria-label="19 / 25" style="width: 1184px;"><div class="slide-internal-box"><h1>Firebaseの落とし穴</h1><ul><li>FirebaseというかExpoの落とし穴だが、ExpoへのPush通知は割と高頻度(週に数回)で502エラーになる<ul><li>400系なら分かるが、502ならどうしようもない</li><li>Expoに問い合わせたが、リトライ処理を実装してくれ、とのこと</li></ul></li><li>メッセージのonCreateハンドラ→Notificationコレクションに書き込み→NotificationコレクションのonCreateハンドラでPush通知を飛ばし、失敗時は再度同じコレクションに書き込み、的な設計でリトライを実装した</li></ul></div></div><div class="swiper-slide" data-hash="slide-20" role="group" aria-label="20 / 25" style="width: 1184px;"><div class="slide-internal-box"><h1>React Nativeで良かったと思うこと</h1></div></div><div class="swiper-slide" data-hash="slide-21" role="group" aria-label="21 / 25" style="width: 1184px;"><div class="slide-internal-box"><h2>1. 簡単な修正ならWebエンジニア(僕)でも理解・実装できる</h2><ul><li>そもそもReactが個人的に好き(突然の主観)<ul><li>最近練習を兼ねてRNで個人開発しているが、TSXを書くのが楽しいしスタイルもCSS感覚なので敷居が本当に低い</li></ul></li><li>特にExpoのManaged Workflowの場合は環境構築時に各OSの存在をほとんど意識しなくて良いので楽</li><li>実例として、FrontのFirebaseは全く同じライブラリをVueでも使っているので、Webのコードをほぼそのままコピペで持ってこれる<ul><li>先日FirebaseのStorageにファイルを上げる時に、content-dispositionヘッダを指定することでダウンロード時にファイル名を維持する施策を実装したが、ほぼ同じコードでWeb/アプリを実装できたので便利さを実感した</li></ul></li></ul></div></div><div class="swiper-slide" data-hash="slide-22" role="group" aria-label="22 / 25" style="width: 1184px;"><div class="slide-internal-box"><h2>2. 受験シーズンに間に合うように開発できた！</h2><ul><li>昨年6月から開発スタートし10月にリリース<ul><li>React Nativeで開発することで受験シーズンに間に合い、積極的に使ってもらうことができた</li></ul></li><li>ほぼチャット機能のみの<strong>シンプルなアプリでも好評だった</strong><ul><li>親・先生・生徒がやり取りでき、ファイルや画像も送れるのは当然に見えて、案外事業者側でそこまで内製する企業が少ないらしい</li><li>特に先生から好評をいただくことができた</li></ul></li><li><strong>教育事業が最も盛り上がる受験シーズンまでに、最低限どんな機能があればニーズが満たせるか理解できた</strong><ul><li>スタートアップの検証サイクル的にはとても有り難い技術</li><li>(初期リリースの内容を予定から絞って、チャットだけを作り込む判断も功を奏した)</li></ul></li></ul></div></div><div class="swiper-slide" data-hash="slide-23" role="group" aria-label="23 / 25" style="width: 1184px;"><div class="slide-internal-box"><h1>まとめ</h1><ul><li>React Nativeのチャット機能開発<ul><li>UIはreact-native-gifted-chatが便利</li><li>データ読み込みはHooks関連のライブラリが便利</li><li>エラー検知はSentryが便利</li></ul></li><li>Firebaseのチャット機能開発<ul><li>読み取りの都合に合わせて非正規化や冗長性を許容する</li><li>Cloud FunctionsのonWrite等を使って同期</li></ul></li><li>開発体制を柔軟に決められる技術スタックなので大変助かっている</li></ul></div></div><div class="swiper-slide" data-hash="slide-24" role="group" aria-label="24 / 25" style="width: 1184px;"><div class="slide-internal-box"><h1>告知</h1><img src="fc9aff93671b30ad8a4f.webp" alt="Image from Gyazo" style="width: 85%;"></div></div><div class="swiper-slide title" data-hash="slide-25" role="group" aria-label="25 / 25" style="width: 1184px;"><div class="slide-internal-box"><h1>ご清聴ありがとうございました</h1><div class="grid"><a href="https://twitter.com/meijin_garden" class="account account-twitter" aria-label="account-twitter"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path></svg></a></div><span style="margin-left: 12px; font-weight: bold; color: rgb(136, 136, 204);">Twitter: @Meijin_garden</span></div></div></div><span class="swiper-notification" aria-live="assertive" aria-atomic="true"></span></div></div></body></html>