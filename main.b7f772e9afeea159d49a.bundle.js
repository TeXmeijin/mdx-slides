(self.webpackChunkslides=self.webpackChunkslides||[]).push([[179],{8085:(t,e,l)=>{"use strict";l.r(e),l.d(e,{slides:()=>i,backgrounds:()=>k,fragmentSteps:()=>m,fusumaProps:()=>p,default:()=>o});var a=l(7401),n=l(9332),r=(l(108),l(6465));function u(){return(u=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var l=arguments[e];for(var a in l)Object.prototype.hasOwnProperty.call(l,a)&&(t[a]=l[a])}return t}).apply(this,arguments)}const i=[t=>(0,n.kt)(a.Fragment,null,(0,n.kt)("h1",null,(0,n.kt)("span",null,"React Native×Firebaseで"),(0,n.kt)("span",null,"オンライン指導用の"),(0,n.kt)("span",null,"チャットアプリを開発している話")),(0,n.kt)("div",{className:"grid"},(0,n.kt)("a",{href:"https://twitter.com/meijin_garden",className:"account account-twitter","aria-label":"account-twitter"},(0,n.kt)(r.fWC,null)))),t=>(0,n.kt)(a.Fragment,null,(0,n.kt)("h1",null,"目次"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"自己紹介"),(0,n.kt)("li",{parentName:"ul"},"開発しているサービス"),(0,n.kt)("li",{parentName:"ul"},"React Nativeの利用ライブラリ"),(0,n.kt)("li",{parentName:"ul"},"React Nativeの品質管理"),(0,n.kt)("li",{parentName:"ul"},"React Nativeの落とし穴"),(0,n.kt)("li",{parentName:"ul"},"Firebaseの利用ライブラリ"),(0,n.kt)("li",{parentName:"ul"},"Firebaseの品質管理"),(0,n.kt)("li",{parentName:"ul"},"Firebaseの落とし穴"),(0,n.kt)("li",{parentName:"ul"},"この技術選定で良かったと思うこと"),(0,n.kt)("li",{parentName:"ul"},"まとめ"))),t=>(0,n.kt)(a.Fragment,null,(0,n.kt)("h1",null,"自己紹介"),(0,n.kt)("div",{className:"grid"},(0,n.kt)("div",{className:"column"},(0,n.kt)("figure",null,(0,n.kt)("img",{src:l(1996),alt:"自己紹介",className:"self-introduce",width:"200",height:"320"}))),(0,n.kt)("div",{className:"column left flex-start"},(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"ハンドルネーム”名人”"),(0,n.kt)("li",{parentName:"ul"},"株式会社NoSchool CTO"),(0,n.kt)("li",{parentName:"ul"},"オンライン家庭教師を広める教育サービス”マナリンク”を開発しています(",(0,n.kt)("a",{parentName:"li",href:"https://manalink.jp"},"https://manalink.jp"),")"),(0,n.kt)("li",{parentName:"ul"},"好きな言語はTypeScript"),(0,n.kt)("li",{parentName:"ul"},"好きなIDEはPHPStorm"),(0,n.kt)("li",{parentName:"ul"},"趣味",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"将棋(指すのも観戦するのも好き)"),(0,n.kt)("li",{parentName:"ul"},"ゲーム(最近はゼルダ無双)"))))))),t=>(0,n.kt)(a.Fragment,null,(0,n.kt)("h1",null,"開発しているサービス"),(0,n.kt)("div",{className:"grid"},(0,n.kt)("div",{className:"column"},(0,n.kt)("img",{src:l(7685),alt:"Image from Gyazo",style:{width:350}})),(0,n.kt)("div",{className:"column left flex-start"},(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"マナリンク"),(0,n.kt)("li",{parentName:"ul"},"中高生向けのオンライン家庭教師サービス"),(0,n.kt)("li",{parentName:"ul"},"Web上で先生を探して指導依頼"),(0,n.kt)("li",{parentName:"ul"},"指導開始後はアプリを使ってご家庭↔先生でやり取り"))))),t=>(0,n.kt)(a.Fragment,null,(0,n.kt)("h1",null,"図にするとこんな感じ"),(0,n.kt)("img",{src:l(7591),alt:"Image from Gyazo",style:{width:"90%"}})),t=>(0,n.kt)(a.Fragment,null,(0,n.kt)("h1",null,"アプリで開発している機能"),(0,n.kt)("h2",null,"いま"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"先生、生徒、保護者が利用できる"),(0,n.kt)("li",{parentName:"ul"},"チャット(文章、画像、PDF、.docxなど)で連絡できる",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"iOS / Android対応"),(0,n.kt)("li",{parentName:"ul"},"Web(Nuxt.js)↔アプリ間でもチャットができる")))),(0,n.kt)("h2",null,"これから"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"先生が勉強計画を立て、日々生徒が報告する機能"),(0,n.kt)("li",{parentName:"ul"},"試験日や指導日を共有できる管理機能")),(0,n.kt)("p",null,(0,n.kt)("strong",{parentName:"p"},"→先生個人が(塾などに属さなくても)デジタル化した指導を実践できるようにしていく"))),t=>(0,n.kt)(a.Fragment,null,(0,n.kt)("h1",null,"アプリの開発体制と利用技術"),(0,n.kt)("div",{className:"grid"},(0,n.kt)("div",{className:"flex"},(0,n.kt)("img",{src:l(125),alt:"Image from Gyazo",style:{height:500,width:220}}),(0,n.kt)("img",{src:l(4884),alt:"Image from Gyazo",style:{height:500,width:220,marginLeft:20}})),(0,n.kt)("div",{className:"column left flex-start"},(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"開発体制",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"業務委託エンジニア1名(+ときどきCTO)"),(0,n.kt)("li",{parentName:"ul"},"めっちゃベンチャーです"))),(0,n.kt)("li",{parentName:"ul"},"利用技術",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"React Native"),(0,n.kt)("li",{parentName:"ul"},"Expo(Managed Workflow)"),(0,n.kt)("li",{parentName:"ul"},"Firebase"),(0,n.kt)("li",{parentName:"ul"},"TypeScript"))))))),t=>(0,n.kt)(a.Fragment,null,(0,n.kt)("h1",null,"React Nativeの利用ライブラリ")),t=>(0,n.kt)(a.Fragment,null,(0,n.kt)("h1",null,"react-native-gifted-chat"),(0,n.kt)("div",{className:"grid"},(0,n.kt)("div",{className:"column"},(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-jsx"},'<GiftedChat\n  messages={chatMessages}\n  onSend={onSend}\n  placeholder="メッセージを入力"\n  renderBubble={renderBubble}\n  renderInputToolbar={renderInputToolbar}\n  renderActions={renderActions}\n  renderComposer={renderComposer}\n  renderSend={renderSend}\n  renderMessageImage={renderMessageImage}\n  infiniteScroll\n  // 以下略\n/>\n'))),(0,n.kt)("div",{className:"column left"},(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"チャット画面を丸っと囲うGiftedChatコンポーネントを置くだけ"),(0,n.kt)("li",{parentName:"ul"},"各メッセージや送信ボタンなどは外からFunctionalなComponentを渡すことでカスタマイズできる"),(0,n.kt)("li",{parentName:"ul"},"カスタマイズしすぎるとライブラリの範囲を逸脱してくるので、いつかはリプレイスする"))))),t=>(0,n.kt)(a.Fragment,null,(0,n.kt)("h1",null,"チャットをゼロから作るのは割と大変"),(0,n.kt)("div",{className:"grid"},(0,n.kt)("div",{className:"flex"},(0,n.kt)("img",{src:l(7586),alt:"Image from Gyazo",style:{width:330}})),(0,n.kt)("div",{className:"column left flex-start"},(0,n.kt)("h4",null,"以下の内容はreact-native-gifted-chatがやっている"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"チャットの吹き出しの形",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"よく見ると、連投したときの角丸の形が微妙に違う"),(0,n.kt)("li",{parentName:"ul"},"連投すると最後の投稿だけユーザーアイコンがつく"))),(0,n.kt)("li",{parentName:"ul"},"日時表示",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"日付が変わるたびに日付表示をインサートしている"))),(0,n.kt)("li",{parentName:"ul"},"表示位置",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"新着メッセージが来るたびに自動でスクロール")))),(0,n.kt)("p",null,"WebではVueで全部自作したけど結構大変だった(勉強にはなった)"),(0,n.kt)("p",null,"これを機にLINEのUIをじっくり眺めるととても感心した思い出")))),t=>(0,n.kt)(a.Fragment,null,(0,n.kt)("h1",null,"Firebase×React Hooks関連のライブラリ"),(0,n.kt)("h2",null,"react-firebase-hooks"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/CSFrequency/react-firebase-hooks"},"https://github.com/CSFrequency/react-firebase-hooks")),(0,n.kt)("li",{parentName:"ul"},"FirestoreのCollectionデータ、読み込み中フラグ、エラー内容をセットで返すHook")),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-typescript"},"const [values, loading, error] = useCollectionData<T>(query, options);\n")),(0,n.kt)("br",null),(0,n.kt)("h2",null,"react-firebase-pagination-hooks"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"チャットのメッセージをページングして、無限スクロールを実装"),(0,n.kt)("li",{parentName:"ul"},"loadMoreメソッドを実行すれば次のデータが読み込める")),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-typescript"},"const [messages, { loaded, loadingMore, loadMore }, error] = usePaginationData<T>(query, options);\n"))),t=>(0,n.kt)(a.Fragment,null,(0,n.kt)("h1",null,"React Nativeの品質管理"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"React Nativeに関してはテストコードは皆無(汗)",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"機能が少なく、ライブラリ依存が大きいため"),(0,n.kt)("li",{parentName:"ul"},"毎回ウォークスルーテストを手動でしている"),(0,n.kt)("li",{parentName:"ul"},"複雑なフックが増えてきたので書きたい気持ちはある"))),(0,n.kt)("li",{parentName:"ul"},"エラー検知はSentry",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"画面遷移やメッセージ送信時などでイベントを発火して記録"),(0,n.kt)("li",{parentName:"ul"},"エラーログが出ると、イベントを辿ることでユーザーの動きを擬似再現できる"),(0,n.kt)("li",{parentName:"ul"},"ユーザーIDも紐付けができる"),(0,n.kt)("li",{parentName:"ul"},"ソースマップをSentryにデプロイすることで、エラーが起きたソースコードの該当箇所を特定しやすい")))),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-typescript"},"Sentry.addBreadcrumb({\n  category: 'ACTION',\n  message: 'SEND_CHAT_MESSAGE',\n  data: {\n    roomId: room.id,\n    userId: user.id,\n  },\n});\n"))),t=>(0,n.kt)(a.Fragment,null,(0,n.kt)("h1",null,"React Nativeの落とし穴"),(0,n.kt)("h2",null,"ハマると解決が厳しい"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"某ライブラリと某ライブラリを併用し、かつ特定の動作をユーザーが行うとアプリがクラッシュする事案があった",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"画面が突然ブラックアウトして強制的に再起動になる"),(0,n.kt)("li",{parentName:"ul"},"発動条件がニッチだが、本番環境で再現するユーザーがいて修正必須となった"),(0,n.kt)("li",{parentName:"ul"},"直接的な原因が全く不明"),(0,n.kt)("li",{parentName:"ul"},"クラッシュが突然ブラックアウトするためエラーログが取れない"),(0,n.kt)("li",{parentName:"ul"},"ライブラリのソースを追っても、ある程度追うとネイティブのコードになり謎が深まる")))),(0,n.kt)("p",null,"結局何が原因か分からないままに、当該ライブラリの組み合わせを変えることで解消...")),t=>(0,n.kt)(a.Fragment,null,(0,n.kt)("h2",null,"いつでもiOS/Androidで同じと思うなよ現象"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"チャットで画像を送信するとき、画素数を落とさずにファイルサイズを小さくするために圧縮した",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"expo-image-manipulatorのImageManipulator.manipulateAsyncで圧縮しようとすると、同じ圧縮率を指定してもAndroidから実行すると",(0,n.kt)("strong",{parentName:"li"},"画像が圧縮されすぎてしまった")),(0,n.kt)("li",{parentName:"ul"},"OSごとに分岐して圧縮率を調整することで解消"),(0,n.kt)("li",{parentName:"ul"},"ソースレビューの段階では何ら問題なく見えるので恐ろしい"))),(0,n.kt)("li",{parentName:"ul"},"他にも通知周りなど、細かいところで結局OSごとに分岐する箇所があるので、両OSでの実機確認は必須"))),t=>(0,n.kt)(a.Fragment,null,(0,n.kt)("h1",null,"Firebaseの利用ライブラリ")),t=>(0,n.kt)(a.Fragment,null,(0,n.kt)("h2",null,"firestore-simple"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"Firestoreに対する形安全なDAOが手に入れられるライブラリ")),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-typescript"},"const roomDao = firestoreSimple.collection<Room>({ path: 'rooms' })\nconst allRooms = await roomDao.fetchAll() // allRooms: Room[]\n"))),t=>(0,n.kt)(a.Fragment,null,(0,n.kt)("h1",null,"Firebaseの設計"),(0,n.kt)("h2",null,"Firestoreは書き込み処理に重点を置く"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"SQLと違って読み取りクエリが貧弱"),(0,n.kt)("li",{parentName:"ul"},"非正規化を許容して、読み取りの仕様に合わせて最適化したコレクションを作る"),(0,n.kt)("li",{parentName:"ul"},"例：チャット部屋一覧で最新のメッセージを見せるために、messagesコレクションのonCreateでroomsコレクションに最新のメッセージを遅れて同期させる"),(0,n.kt)("li",{parentName:"ul"},"例：全ての未読数の合計を出すために、messagesへのonWriteハンドラでユーザーごとに未読数を集計して別途保存する"))),t=>(0,n.kt)(a.Fragment,null,(0,n.kt)("h1",null,"Firebaseの品質管理"),(0,n.kt)("h2",null,"FunctionsでのエラーログをSlack通知"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://zenn.dev/meijin/scraps/94d4a70eb77507"},"https://zenn.dev/meijin/scraps/94d4a70eb77507")),(0,n.kt)("li",{parentName:"ul"},"Functionsでキャッチされなかった例外も含めSlack等でキャッチアップしたかった"),(0,n.kt)("li",{parentName:"ul"},"Cloud Functionsログ→GCP→ログルーター→PubSubトピック→Cloud Function→Slack通知"))),t=>(0,n.kt)(a.Fragment,null,(0,n.kt)("h1",null,"Firebaseの落とし穴"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"FirebaseというかExpoの落とし穴だが、ExpoへのPush通知は割と高頻度(週に数回)で502エラーになる",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"400系なら分かるが、502ならどうしようもない"),(0,n.kt)("li",{parentName:"ul"},"Expoに問い合わせたが、リトライ処理を実装してくれ、とのこと"))),(0,n.kt)("li",{parentName:"ul"},"メッセージのonCreateハンドラ→Notificationコレクションに書き込み→NotificationコレクションのonCreateハンドラでPush通知を飛ばし、失敗時は再度同じコレクションに書き込み、的な設計でリトライを実装した"))),t=>(0,n.kt)(a.Fragment,null,(0,n.kt)("h1",null,"React Nativeで良かったと思うこと")),t=>(0,n.kt)(a.Fragment,null,(0,n.kt)("h2",null,"1. 簡単な修正ならWebエンジニア(僕)でも理解・実装できる"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"そもそもReactが個人的に好き(突然の主観)",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"最近練習を兼ねてRNで個人開発しているが、TSXを書くのが楽しいしスタイルもCSS感覚なので敷居が本当に低い"))),(0,n.kt)("li",{parentName:"ul"},"特にExpoのManaged Workflowの場合は環境構築時に各OSの存在をほとんど意識しなくて良いので楽"),(0,n.kt)("li",{parentName:"ul"},"実例として、FrontのFirebaseは全く同じライブラリをVueでも使っているので、Webのコードをほぼそのままコピペで持ってこれる",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"先日FirebaseのStorageにファイルを上げる時に、content-dispositionヘッダを指定することでダウンロード時にファイル名を維持する施策を実装したが、ほぼ同じコードでWeb/アプリを実装できたので便利さを実感した"))))),t=>(0,n.kt)(a.Fragment,null,(0,n.kt)("h2",null,"2. 受験シーズンに間に合うように開発でき、機能検証ができた"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"昨年6月から開発スタートし、紆余曲折あったが10月にはリリースできた"),(0,n.kt)("li",{parentName:"ul"},"オンライン指導用のアプリなので、クロスプラットフォームで平等に使ってもらう必要があった"),(0,n.kt)("li",{parentName:"ul"},"React Nativeで開発することで受験シーズンに間に合い、積極的に使ってもらうことができた"),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("strong",{parentName:"li"},"チャットで親・先生・生徒がやり取りでき、ファイルや画像も送れるのはIT界隈の人間からすると当然だが、案外事業者側でそこまで内製する企業が少ないらしく、特に先生から好評をいただくことができた"),(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"実際、チャット機能は作り込みだすとそれなりに大変ですが(小声)"))),(0,n.kt)("li",{parentName:"ul"},"総じて、",(0,n.kt)("strong",{parentName:"li"},"教育事業が最も盛り上がる受験シーズンまでに、最低限どんな機能があればニーズが満たせるか理解できた"),"ので、React Nativeをやってよかった",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"スタートアップの検証サイクル的にはとても有り難い技術"),(0,n.kt)("li",{parentName:"ul"},"(初期リリースの内容を予定から絞って、チャットをまずは作り込む判断も良かった)"))))),t=>(0,n.kt)(a.Fragment,null,(0,n.kt)("h1",null,"まとめ"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"React Nativeのチャット機能開発",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"UIはreact-native-gifted-chatが便利"),(0,n.kt)("li",{parentName:"ul"},"データ読み込みはHooks関連のライブラリが便利"),(0,n.kt)("li",{parentName:"ul"},"エラー検知はSentryが便利"))),(0,n.kt)("li",{parentName:"ul"},"Firebaseのチャット機能開発",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"読み取りの都合に合わせて非正規化や冗長性を許容する"),(0,n.kt)("li",{parentName:"ul"},"Cloud FunctionsのonWrite等を使って同期"))),(0,n.kt)("li",{parentName:"ul"},"開発体制を柔軟に決められる技術スタックなので大変助かっている"))),t=>(0,n.kt)(a.Fragment,null,(0,n.kt)("h1",null,"告知"),(0,n.kt)("img",{src:l(8353),alt:"Image from Gyazo",style:{width:"90%"}})),t=>(0,n.kt)(a.Fragment,null,(0,n.kt)("h1",null,"ご清聴ありがとうございました"),(0,n.kt)("div",{className:"grid"},(0,n.kt)("a",{href:"https://twitter.com/meijin_garden",className:"account account-twitter","aria-label":"account-twitter"},(0,n.kt)(r.fWC,null))),(0,n.kt)("span",{style:{marginLeft:12,fontWeight:"bold",color:"#8888cc"}},"Twitter: @Meijin_garden"))],k=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],m=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],p=[{classes:"title"},{sectionTitle:"目次"},{},{},{},{classes:"left"},{},{},{classes:"left"},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{classes:"title"}],s={};function o({components:t,...e}){return(0,n.kt)("wrapper",u({},s,e,{components:t,mdxType:"MDXLayout"}),(0,n.kt)("h1",null,(0,n.kt)("span",null,"React Native×Firebaseで"),(0,n.kt)("span",null,"オンライン指導用の"),(0,n.kt)("span",null,"チャットアプリを開発している話")),(0,n.kt)("hr",null),(0,n.kt)("h1",null,"目次"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"自己紹介"),(0,n.kt)("li",{parentName:"ul"},"開発しているサービス"),(0,n.kt)("li",{parentName:"ul"},"React Nativeの利用ライブラリ"),(0,n.kt)("li",{parentName:"ul"},"React Nativeの品質管理"),(0,n.kt)("li",{parentName:"ul"},"React Nativeの落とし穴"),(0,n.kt)("li",{parentName:"ul"},"Firebaseの利用ライブラリ"),(0,n.kt)("li",{parentName:"ul"},"Firebaseの品質管理"),(0,n.kt)("li",{parentName:"ul"},"Firebaseの落とし穴"),(0,n.kt)("li",{parentName:"ul"},"この技術選定で良かったと思うこと"),(0,n.kt)("li",{parentName:"ul"},"まとめ")),(0,n.kt)("hr",null),(0,n.kt)("h1",null,"自己紹介"),(0,n.kt)("figure",null,(0,n.kt)("img",{src:l(1996),alt:"自己紹介",className:"self-introduce",width:"200",height:"320"})),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"ハンドルネーム”名人”"),(0,n.kt)("li",{parentName:"ul"},"株式会社NoSchool CTO"),(0,n.kt)("li",{parentName:"ul"},"オンライン家庭教師を広める教育サービス”マナリンク”を開発しています(",(0,n.kt)("a",{parentName:"li",href:"https://manalink.jp"},"https://manalink.jp"),")"),(0,n.kt)("li",{parentName:"ul"},"好きな言語はTypeScript"),(0,n.kt)("li",{parentName:"ul"},"好きなIDEはPHPStorm"),(0,n.kt)("li",{parentName:"ul"},"趣味",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"将棋(指すのも観戦するのも好き)"),(0,n.kt)("li",{parentName:"ul"},"ゲーム(最近はゼルダ無双)")))),(0,n.kt)("hr",null),(0,n.kt)("h1",null,"開発しているサービス"),(0,n.kt)("img",{src:l(7685),alt:"Image from Gyazo",style:{width:350}}),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"マナリンク"),(0,n.kt)("li",{parentName:"ul"},"中高生向けのオンライン家庭教師サービス"),(0,n.kt)("li",{parentName:"ul"},"Web上で先生を探して指導依頼"),(0,n.kt)("li",{parentName:"ul"},"指導開始後はアプリを使ってご家庭↔先生でやり取り")),(0,n.kt)("hr",null),(0,n.kt)("h1",null,"図にするとこんな感じ"),(0,n.kt)("img",{src:l(7591),alt:"Image from Gyazo",style:{width:"90%"}}),(0,n.kt)("hr",null),(0,n.kt)("h1",null,"アプリで開発している機能"),(0,n.kt)("h2",null,"いま"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"先生、生徒、保護者が利用できる"),(0,n.kt)("li",{parentName:"ul"},"チャット(文章、画像、PDF、.docxなど)で連絡できる",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"iOS / Android対応"),(0,n.kt)("li",{parentName:"ul"},"Web(Nuxt.js)↔アプリ間でもチャットができる")))),(0,n.kt)("h2",null,"これから"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"先生が勉強計画を立て、日々生徒が報告する機能"),(0,n.kt)("li",{parentName:"ul"},"試験日や指導日を共有できる管理機能")),(0,n.kt)("p",null,(0,n.kt)("strong",{parentName:"p"},"→先生個人が(塾などに属さなくても)デジタル化した指導を実践できるようにしていく")),(0,n.kt)("hr",null),(0,n.kt)("h1",null,"アプリの開発体制と利用技術"),(0,n.kt)("img",{src:l(125),alt:"Image from Gyazo",style:{height:500,width:220}}),(0,n.kt)("img",{src:l(4884),alt:"Image from Gyazo",style:{height:500,width:220,marginLeft:20}}),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"開発体制",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"業務委託エンジニア1名(+ときどきCTO)"),(0,n.kt)("li",{parentName:"ul"},"めっちゃベンチャーです"))),(0,n.kt)("li",{parentName:"ul"},"利用技術",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"React Native"),(0,n.kt)("li",{parentName:"ul"},"Expo(Managed Workflow)"),(0,n.kt)("li",{parentName:"ul"},"Firebase"),(0,n.kt)("li",{parentName:"ul"},"TypeScript")))),(0,n.kt)("hr",null),(0,n.kt)("h1",null,"React Nativeの利用ライブラリ"),(0,n.kt)("hr",null),(0,n.kt)("h1",null,"react-native-gifted-chat"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-jsx"},'<GiftedChat\n  messages={chatMessages}\n  onSend={onSend}\n  placeholder="メッセージを入力"\n  renderBubble={renderBubble}\n  renderInputToolbar={renderInputToolbar}\n  renderActions={renderActions}\n  renderComposer={renderComposer}\n  renderSend={renderSend}\n  renderMessageImage={renderMessageImage}\n  infiniteScroll\n  // 以下略\n/>\n')),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"チャット画面を丸っと囲うGiftedChatコンポーネントを置くだけ"),(0,n.kt)("li",{parentName:"ul"},"各メッセージや送信ボタンなどは外からFunctionalなComponentを渡すことでカスタマイズできる"),(0,n.kt)("li",{parentName:"ul"},"カスタマイズしすぎるとライブラリの範囲を逸脱してくるので、いつかはリプレイスする")),(0,n.kt)("hr",null),(0,n.kt)("h1",null,"チャットをゼロから作るのは割と大変"),(0,n.kt)("img",{src:l(7586),alt:"Image from Gyazo",style:{width:330}}),(0,n.kt)("h4",null,"以下の内容はreact-native-gifted-chatがやっている"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"チャットの吹き出しの形",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"よく見ると、連投したときの角丸の形が微妙に違う"),(0,n.kt)("li",{parentName:"ul"},"連投すると最後の投稿だけユーザーアイコンがつく"))),(0,n.kt)("li",{parentName:"ul"},"日時表示",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"日付が変わるたびに日付表示をインサートしている"))),(0,n.kt)("li",{parentName:"ul"},"表示位置",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"新着メッセージが来るたびに自動でスクロール")))),(0,n.kt)("p",null,"WebではVueで全部自作したけど結構大変だった(勉強にはなった)"),(0,n.kt)("p",null,"これを機にLINEのUIをじっくり眺めるととても感心した思い出"),(0,n.kt)("hr",null),(0,n.kt)("h1",null,"Firebase×React Hooks関連のライブラリ"),(0,n.kt)("h2",null,"react-firebase-hooks"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/CSFrequency/react-firebase-hooks"},"https://github.com/CSFrequency/react-firebase-hooks")),(0,n.kt)("li",{parentName:"ul"},"FirestoreのCollectionデータ、読み込み中フラグ、エラー内容をセットで返すHook")),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-typescript"},"const [values, loading, error] = useCollectionData<T>(query, options);\n")),(0,n.kt)("br",null),(0,n.kt)("h2",null,"react-firebase-pagination-hooks"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"チャットのメッセージをページングして、無限スクロールを実装"),(0,n.kt)("li",{parentName:"ul"},"loadMoreメソッドを実行すれば次のデータが読み込める")),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-typescript"},"const [messages, { loaded, loadingMore, loadMore }, error] = usePaginationData<T>(query, options);\n")),(0,n.kt)("hr",null),(0,n.kt)("h1",null,"React Nativeの品質管理"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"React Nativeに関してはテストコードは皆無(汗)",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"機能が少なく、ライブラリ依存が大きいため"),(0,n.kt)("li",{parentName:"ul"},"毎回ウォークスルーテストを手動でしている"),(0,n.kt)("li",{parentName:"ul"},"複雑なフックが増えてきたので書きたい気持ちはある"))),(0,n.kt)("li",{parentName:"ul"},"エラー検知はSentry",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"画面遷移やメッセージ送信時などでイベントを発火して記録"),(0,n.kt)("li",{parentName:"ul"},"エラーログが出ると、イベントを辿ることでユーザーの動きを擬似再現できる"),(0,n.kt)("li",{parentName:"ul"},"ユーザーIDも紐付けができる"),(0,n.kt)("li",{parentName:"ul"},"ソースマップをSentryにデプロイすることで、エラーが起きたソースコードの該当箇所を特定しやすい")))),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-typescript"},"Sentry.addBreadcrumb({\n  category: 'ACTION',\n  message: 'SEND_CHAT_MESSAGE',\n  data: {\n    roomId: room.id,\n    userId: user.id,\n  },\n});\n")),(0,n.kt)("hr",null),(0,n.kt)("h1",null,"React Nativeの落とし穴"),(0,n.kt)("h2",null,"ハマると解決が厳しい"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"某ライブラリと某ライブラリを併用し、かつ特定の動作をユーザーが行うとアプリがクラッシュする事案があった",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"画面が突然ブラックアウトして強制的に再起動になる"),(0,n.kt)("li",{parentName:"ul"},"発動条件がニッチだが、本番環境で再現するユーザーがいて修正必須となった"),(0,n.kt)("li",{parentName:"ul"},"直接的な原因が全く不明"),(0,n.kt)("li",{parentName:"ul"},"クラッシュが突然ブラックアウトするためエラーログが取れない"),(0,n.kt)("li",{parentName:"ul"},"ライブラリのソースを追っても、ある程度追うとネイティブのコードになり謎が深まる")))),(0,n.kt)("p",null,"結局何が原因か分からないままに、当該ライブラリの組み合わせを変えることで解消..."),(0,n.kt)("hr",null),(0,n.kt)("h2",null,"いつでもiOS/Androidで同じと思うなよ現象"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"チャットで画像を送信するとき、画素数を落とさずにファイルサイズを小さくするために圧縮した",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"expo-image-manipulatorのImageManipulator.manipulateAsyncで圧縮しようとすると、同じ圧縮率を指定してもAndroidから実行すると",(0,n.kt)("strong",{parentName:"li"},"画像が圧縮されすぎてしまった")),(0,n.kt)("li",{parentName:"ul"},"OSごとに分岐して圧縮率を調整することで解消"),(0,n.kt)("li",{parentName:"ul"},"ソースレビューの段階では何ら問題なく見えるので恐ろしい"))),(0,n.kt)("li",{parentName:"ul"},"他にも通知周りなど、細かいところで結局OSごとに分岐する箇所があるので、両OSでの実機確認は必須")),(0,n.kt)("hr",null),(0,n.kt)("h1",null,"Firebaseの利用ライブラリ"),(0,n.kt)("hr",null),(0,n.kt)("h2",null,"firestore-simple"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"Firestoreに対する形安全なDAOが手に入れられるライブラリ")),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-typescript"},"const roomDao = firestoreSimple.collection<Room>({ path: 'rooms' })\nconst allRooms = await roomDao.fetchAll() // allRooms: Room[]\n")),(0,n.kt)("hr",null),(0,n.kt)("h1",null,"Firebaseの設計"),(0,n.kt)("h2",null,"Firestoreは書き込み処理に重点を置く"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"SQLと違って読み取りクエリが貧弱"),(0,n.kt)("li",{parentName:"ul"},"非正規化を許容して、読み取りの仕様に合わせて最適化したコレクションを作る"),(0,n.kt)("li",{parentName:"ul"},"例：チャット部屋一覧で最新のメッセージを見せるために、messagesコレクションのonCreateでroomsコレクションに最新のメッセージを遅れて同期させる"),(0,n.kt)("li",{parentName:"ul"},"例：全ての未読数の合計を出すために、messagesへのonWriteハンドラでユーザーごとに未読数を集計して別途保存する")),(0,n.kt)("hr",null),(0,n.kt)("h1",null,"Firebaseの品質管理"),(0,n.kt)("h2",null,"FunctionsでのエラーログをSlack通知"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://zenn.dev/meijin/scraps/94d4a70eb77507"},"https://zenn.dev/meijin/scraps/94d4a70eb77507")),(0,n.kt)("li",{parentName:"ul"},"Functionsでキャッチされなかった例外も含めSlack等でキャッチアップしたかった"),(0,n.kt)("li",{parentName:"ul"},"Cloud Functionsログ→GCP→ログルーター→PubSubトピック→Cloud Function→Slack通知")),(0,n.kt)("hr",null),(0,n.kt)("h1",null,"Firebaseの落とし穴"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"FirebaseというかExpoの落とし穴だが、ExpoへのPush通知は割と高頻度(週に数回)で502エラーになる",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"400系なら分かるが、502ならどうしようもない"),(0,n.kt)("li",{parentName:"ul"},"Expoに問い合わせたが、リトライ処理を実装してくれ、とのこと"))),(0,n.kt)("li",{parentName:"ul"},"メッセージのonCreateハンドラ→Notificationコレクションに書き込み→NotificationコレクションのonCreateハンドラでPush通知を飛ばし、失敗時は再度同じコレクションに書き込み、的な設計でリトライを実装した")),(0,n.kt)("hr",null),(0,n.kt)("h1",null,"React Nativeで良かったと思うこと"),(0,n.kt)("hr",null),(0,n.kt)("h2",null,"1. 簡単な修正ならWebエンジニア(僕)でも理解・実装できる"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"そもそもReactが個人的に好き(突然の主観)",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"最近練習を兼ねてRNで個人開発しているが、TSXを書くのが楽しいしスタイルもCSS感覚なので敷居が本当に低い"))),(0,n.kt)("li",{parentName:"ul"},"特にExpoのManaged Workflowの場合は環境構築時に各OSの存在をほとんど意識しなくて良いので楽"),(0,n.kt)("li",{parentName:"ul"},"実例として、FrontのFirebaseは全く同じライブラリをVueでも使っているので、Webのコードをほぼそのままコピペで持ってこれる",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"先日FirebaseのStorageにファイルを上げる時に、content-dispositionヘッダを指定することでダウンロード時にファイル名を維持する施策を実装したが、ほぼ同じコードでWeb/アプリを実装できたので便利さを実感した")))),(0,n.kt)("hr",null),(0,n.kt)("h2",null,"2. 受験シーズンに間に合うように開発でき、機能検証ができた"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"昨年6月から開発スタートし、紆余曲折あったが10月にはリリースできた"),(0,n.kt)("li",{parentName:"ul"},"オンライン指導用のアプリなので、クロスプラットフォームで平等に使ってもらう必要があった"),(0,n.kt)("li",{parentName:"ul"},"React Nativeで開発することで受験シーズンに間に合い、積極的に使ってもらうことができた"),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("strong",{parentName:"li"},"チャットで親・先生・生徒がやり取りでき、ファイルや画像も送れるのはIT界隈の人間からすると当然だが、案外事業者側でそこまで内製する企業が少ないらしく、特に先生から好評をいただくことができた"),(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"実際、チャット機能は作り込みだすとそれなりに大変ですが(小声)"))),(0,n.kt)("li",{parentName:"ul"},"総じて、",(0,n.kt)("strong",{parentName:"li"},"教育事業が最も盛り上がる受験シーズンまでに、最低限どんな機能があればニーズが満たせるか理解できた"),"ので、React Nativeをやってよかった",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"スタートアップの検証サイクル的にはとても有り難い技術"),(0,n.kt)("li",{parentName:"ul"},"(初期リリースの内容を予定から絞って、チャットをまずは作り込む判断も良かった)")))),(0,n.kt)("hr",null),(0,n.kt)("h1",null,"まとめ"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"React Nativeのチャット機能開発",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"UIはreact-native-gifted-chatが便利"),(0,n.kt)("li",{parentName:"ul"},"データ読み込みはHooks関連のライブラリが便利"),(0,n.kt)("li",{parentName:"ul"},"エラー検知はSentryが便利"))),(0,n.kt)("li",{parentName:"ul"},"Firebaseのチャット機能開発",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"読み取りの都合に合わせて非正規化や冗長性を許容する"),(0,n.kt)("li",{parentName:"ul"},"Cloud FunctionsのonWrite等を使って同期"))),(0,n.kt)("li",{parentName:"ul"},"開発体制を柔軟に決められる技術スタックなので大変助かっている")),(0,n.kt)("hr",null),(0,n.kt)("h1",null,"告知"),(0,n.kt)("img",{src:l(8353),alt:"Image from Gyazo",style:{width:"90%"}}),(0,n.kt)("hr",null),(0,n.kt)("h1",null,"ご清聴ありがとうございました"),(0,n.kt)("span",{style:{marginLeft:12,fontWeight:"bold",color:"#8888cc"}},"Twitter: @Meijin_garden"))}o.isMDXComponent=!0},5516:(t,e,l)=>{"use strict";l.r(e)},8353:(t,e,l)=>{"use strict";t.exports=l.p+"fc9aff93671b30ad8a4f.webp"},7586:(t,e,l)=>{"use strict";t.exports=l.p+"4cd6dddd3aedab0b8326.webp"},125:(t,e,l)=>{"use strict";t.exports=l.p+"1e26f5e050e96a101f3b.webp"},4884:(t,e,l)=>{"use strict";t.exports=l.p+"4c379f54d4cc60ecd3e5.webp"},7685:(t,e,l)=>{"use strict";t.exports=l.p+"a5178017b682998d3f57.webp"},7591:(t,e,l)=>{"use strict";t.exports=l.p+"96dcaed69c1891edccc8.webp"},1996:(t,e,l)=>{"use strict";t.exports=l.p+"aa307a7cc38382b5fd86.webp"},3447:(t,e,l)=>{var a={"./0-react-native-firebase-chat.md":8085};function n(t){var e=r(t);return l(e)}function r(t){if(!l.o(a,t)){var e=new Error("Cannot find module '"+t+"'");throw e.code="MODULE_NOT_FOUND",e}return a[t]}n.keys=function(){return Object.keys(a)},n.resolve=r,t.exports=n,n.id=3447}},function(t){"use strict";var e;e=t.x,t.x=()=>{var l=e();return t.E(921),t.E(626),l}},[[7751,666,736],[2069,666,736],[9969,666,736]]]);